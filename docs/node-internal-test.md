# Тестирование сети Hyperledger Fabric

## Инструменты и окружение

Проверку узла можно осуществить через Web-панель администрирования, а также на низком уровне в командной строке ssh-консоли

* Для просмотра Web-консоли 
    * Откройте  Web-панель адиминстрирования в браузере:  
    `http:<node ip>:4000/admin`   

* SSH-консоль открывается командой  
`ssh mvp_dev@<node ip> -p 9022 -i ssh-key-file`   
  
    * Команды выполняются в CLI- докер-контейнерах развернутых на узлах, поскольку в них уже настроено системное окружение.
Названия cli-контейнеров образуются от названия организации и домена, например, `cli.sberbank.testnet.aft`, поэтому в этой документации мы будем  
обозначать их с помощью переменных окружения ORG и DOMAIN.
В виртуальных машинах эти перменные окружения установлены в соответствующие значения, например 
        ```.bash
        cat ~/.bashrc
        
        ...
        export ORG=sberbank
        export DOMAIN=testnet.aft
        ```

    * Соответственно команды командной строки имеют вид: 
        ```bash
        docker exec -it cli.$ORG.$DOMAIN [команда]
        либо
        docker exec -it cli.$DOMAIN [команда] # для ордерера
        ```


## Проверка узла (через UI)

### Проверка состояния сети 

В консоли можно быстро проверить:

* Наличие организаций в `Консорциуме`
* Наличие канала `common`
* Проверка наличия всех организаций в канале `common` 
* Проверка чейнкода `DNS` 

### Проверка работы сети 

* Создание нового канала
    * Ввести имя канало в поле `Создать канал` и нажать Создать
* Добавление организаций в канал
    * Выбрать канал в списке 
    * В секции `Организации` ввести Имя Организации (если организация новая, то ее IP), нажать `Добавить организацию в канал` 
* Подключение организации к каналу (join)
    * Если вашу организацию добавили в канал, введите имя канала в поле `Присоединиться к каналу (Join channel)`, нажмите 'Присоединиться (Join)'
    * Дождитесь подключения - канал появится в списке (10-15 секунд)
* install chaincode
    * Для установки чейнкода необходимо сформировать zip-архив с исходным кодом и загрузить через кнопку Выбор файла (Choose file) 
    * Из выпадающего списка выбрать язык, на котором написан чейнкод
    * Нажать `Установить чейнокд (Install chaincode)`
* instantiate chaincode
    * после установки выбрать чейнкод в выпадающем списке в секции Чейнкоды (Chaincodes)    
    * ввести параметры инициализации через пробел
    * Нажать `Инициализировать чейнкод (Instantiate chaincode)`   
    * Дождаться иницализации (1-3 минуты) - ради-кнопка чейнкода появиться в списке устанволенных чейнкодов  
* invoke/query chaincode
    * после инициализации выбрать радио-кнопу чейнкода
    * ввести имя функции в поле Function
    * ввести параметры через пробел
    * нажать query ли invoke      
    
## Проверка чере командную строку 

### Проверка наличия контейнеров

В ssh-консоли выполняем команду для просмотра запущенных контенеров docker:
```bash
docker ps
```

Контейнеры относящиеся к **ордереру**:

* **cli**.$DOMAIN
* **orderer**.$DOMAIN
* **www**.$DOMAIN

Контейнеры относящиеся к **организациям**:

* **api**.$ORG.$DOMAIN
* **ca**.$ORG.$DOMAIN
* **cli**.$ORG.$DOMAIN
* **couchdb**.$ORG.$DOMAIN (если используется в конфигурации сети)  #  необязательный
* **peer0**.$ORG.$DOMAIN
* **www**.$ORG.$DOMAIN

### Проверка организаций в Консорциуме
Если организации являются членами консорциума (consortium), они могут создавать свои каналы.

```bash
# Запршиваем конфигурацию системного канала 
docker exec -it cli.$DOMAIN bash -c 'source container-scripts/lib/container-lib.sh; peer channel fetch config system_channel.pb -c system-config-channel -o $ORDERER_ADDRESS $ORDERER_TLSCA_CERT_OPTS' 
# Транслируем конфигурацию в json 
docker exec -it cli.$DOMAIN bash -c 'source container-scripts/lib/container-lib.sh;  configtxlator proto_decode --type "common.Block" --input=common_channel.pb' > system_channel.json  
# Выделяем часть json-конфигурации с информацией о консорциуме
docker exec -it cli.$DOMAIN bash -c 'jq .data.data[0].payload.data.config.channel_group.values.Consortium ./system_channel.json'
```

### Проверка членства в канале `common` 

Проверим, создан ли канал common и подключены ли к нему организации org1 и org2
```bash
docker exec -it cli.$ORG.$DOMAIN bash -c 'source container-scripts/lib/container-lib.sh; peer channel list -o $ORDERER_ADDRESS $ORDERER_TLSCA_CERT_OPTS'
```

Ожидаемый результат выполнения:
```bash
Channels peers has joined: common
```
